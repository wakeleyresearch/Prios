<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Planner - Enhanced</title>
  <link rel="stylesheet" href="theme.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.263.0/font/lucide.min.css" />
</head>
<body>
  <div class="header-nav">
    <div class="brand">Prios</div>
    <div class="links">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="todo-list.html">To-Do</a>
      <a href="task-planner-enhanced.html" class="active">Planner</a>
      <a href="productivity-parallel-coords.html">Analytics</a>
    </div>
  </div>

  <main class="app-shell planner-shell">
    <section class="planner-header surface-card">
      <div>
        <span class="section-title">Planning cadence</span>
        <h1>Weekly Planner</h1>
        <p>Schedule focus blocks, link tasks to goals, and keep momentum aligned with your energy rhythm.</p>
      </div>
      <div class="planner-header-actions">
        <button class="btn btn-ghost" onclick="goToToday()">Go to today</button>
        <button class="btn" onclick="openTaskModal()">New task</button>
      </div>
    </section>

    <section class="planner-layout">
      <aside class="planner-sidebar">
        <div class="surface-panel planner-section">
          <h3 class="section-title">Active goals</h3>
          <div id="goalList" class="goal-list">
            <div class="goal-item active">
              <span class="goal-icon">launch</span>
              <div class="goal-name">Q4 Product Launch</div>
              <div class="goal-progress-text">12/20 tasks completed</div>
              <div class="progress-bar">
                <div class="progress-fill" id="goalProgress1"></div>
              </div>
            </div>
            <div class="goal-item">
              <span class="goal-icon">fitness</span>
              <div class="goal-name">Fitness Goals 2024</div>
              <div class="goal-progress-text">45/60 workouts</div>
              <div class="progress-bar">
                <div class="progress-fill" id="goalProgress2"></div>
              </div>
            </div>
            <div class="goal-item">
              <span class="goal-icon">learn</span>
              <div class="goal-name">Learn Spanish</div>
              <div class="goal-progress-text">120/200 lessons</div>
              <div class="progress-bar">
                <div class="progress-fill" id="goalProgress3"></div>
              </div>
            </div>
          </div>
          <button class="btn btn-ghost" onclick="openGoalModal()">New goal</button>
        </div>

        <div class="surface-panel planner-section">
          <h3 class="section-title">Quick stats</h3>
          <div class="grid gap-2">
            <div class="stat-row">
              <span class="text-secondary text-sm">Today</span>
              <span class="text-sm text-primary-accent font-semibold" data-test="todayTasks">8 tasks</span>
            </div>
            <div class="stat-row">
              <span class="text-secondary text-sm">This week</span>
              <span class="text-sm text-primary-accent font-semibold" data-test="weekTasks">42 tasks</span>
            </div>
            <div class="stat-row">
              <span class="text-secondary text-sm">Completion</span>
              <span class="text-sm text-success font-semibold" data-test="completionRate">78%</span>
            </div>
          </div>
        </div>
      </aside>

      <section class="planner-calendar surface-card">
        <div class="planner-calendar-header">
          <div class="flex items-center gap-2">
            <button class="btn-icon btn-secondary" onclick="navigateWeek(-1)" aria-label="Previous period" title="Previous period">
              <i class="lucide-chevron-left" aria-hidden="true"></i>
            </button>
            <h2 class="card-title" id="weekDisplay">November 18-24, 2024</h2>
            <button class="btn-icon btn-secondary" onclick="navigateWeek(1)" aria-label="Next period" title="Next period">
              <i class="lucide-chevron-right" aria-hidden="true"></i>
            </button>
          </div>
          <div class="planner-calendar-toolbar">
            <label class="sr-only" for="plannerView">Planner view</label>
            <select id="plannerView" class="form-select w-auto" onchange="changeView(this.value)" title="Planner view selector">
              <option value="week" selected>Week view</option>
              <option value="day">Day view</option>
              <option value="month">Month view</option>
            </select>
            <label class="sr-only" for="hourStart">Start hour</label>
            <select id="hourStart" class="form-select w-auto" title="Start hour">
              <option value="6">6 AM</option>
              <option value="7">7 AM</option>
              <option value="8" selected>8 AM</option>
              <option value="9">9 AM</option>
              <option value="10">10 AM</option>
            </select>
            <label class="sr-only" for="hourEnd">End hour</label>
            <select id="hourEnd" class="form-select w-auto" title="End hour">
              <option value="17">5 PM</option>
              <option value="18">6 PM</option>
              <option value="19">7 PM</option>
              <option value="20" selected>8 PM</option>
              <option value="21">9 PM</option>
            </select>
          </div>
        </div>
        <div class="planner-calendar-body">
          <div class="calendar-grid" id="calendarView">
            <div></div>
            <div class="calendar-header-cell">Sun 18</div>
            <div class="calendar-header-cell">Mon 19</div>
            <div class="calendar-header-cell">Tue 20</div>
            <div class="calendar-header-cell today">Wed 21</div>
            <div class="calendar-header-cell">Thu 22</div>
            <div class="calendar-header-cell">Fri 23</div>
            <div class="calendar-header-cell">Sat 24</div>

            <div class="time-slot-label">8:00 AM</div>
            <div class="calendar-cell">
              <div class="task-card priority-low">
                <div class="task-time">8:00 - 8:30</div>
                <div class="task-title">Morning reset</div>
                <div class="task-meta">
                  <span class="task-tag">wellness</span>
                </div>
              </div>
            </div>
            <div class="calendar-cell">
              <div class="task-card priority-high category-work">
                <div class="task-time">8:30 - 9:00</div>
                <div class="task-title">Team standup</div>
                <div class="task-meta">
                  <span class="task-tag">work</span>
                </div>
              </div>
            </div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell">
              <div class="task-card priority-high category-work">
                <div class="task-time">9:00 - 10:30</div>
                <div class="task-title">Launch review</div>
                <div class="task-meta">
                  <span class="task-tag">work</span>
                  <span class="task-tag">goal: launch</span>
                </div>
              </div>
            </div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell">
              <div class="task-card priority-medium category-learning">
                <div class="task-time">8:30 - 9:15</div>
                <div class="task-title">Language practice</div>
                <div class="task-meta">
                  <span class="task-tag">learning</span>
                </div>
              </div>
            </div>
            <div class="calendar-cell calendar-cell-empty"></div>

            <div class="time-slot-label">9:00 AM</div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell calendar-cell-empty today"></div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell calendar-cell-empty"></div>
            <div class="calendar-cell calendar-cell-empty"></div>
          </div>
        </div>
      </section>

      <section class="planner-secondary">
        <div class="surface-panel planner-section quick-add-section">
          <h3 class="section-title">Quick add</h3>
          <div class="quick-add-form">
            <input type="text" class="quick-add-input" placeholder="What needs to be done?" id="quickTaskInput" />
            <button class="btn btn-ghost" onclick="quickAddTask()" aria-label="Quick add task" title="Quick add task">
              <i class="lucide-plus" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <div class="surface-panel planner-section">
          <h3 class="section-title">Focus categories</h3>
          <div class="category-grid">
            <div class="category-card active">
              <div class="category-icon">work</div>
              <div class="category-name">Work</div>
              <div class="category-count">12 tasks</div>
            </div>
            <div class="category-card">
              <div class="category-icon">fitness</div>
              <div class="category-name">Fitness</div>
              <div class="category-count">5 tasks</div>
            </div>
            <div class="category-card">
              <div class="category-icon">learning</div>
              <div class="category-name">Learning</div>
              <div class="category-count">8 tasks</div>
            </div>
            <div class="category-card">
              <div class="category-icon">personal</div>
              <div class="category-name">Personal</div>
              <div class="category-count">6 tasks</div>
            </div>
          </div>
        </div>

        <div class="surface-panel planner-section">
          <h3 class="section-title">Templates</h3>
          <div class="grid gap-2">
            <button class="btn btn-secondary justify-start" onclick="addTemplate('standup')" aria-label="Add daily standup template">
              <i class="lucide-users" aria-hidden="true"></i>
              <span>Daily standup</span>
            </button>
            <button class="btn btn-secondary justify-start" onclick="addTemplate('workout')" aria-label="Add workout template">
              <i class="lucide-dumbbell" aria-hidden="true"></i>
              <span>Workout session</span>
            </button>
            <button class="btn btn-secondary justify-start" onclick="addTemplate('review')" aria-label="Add weekly review template">
              <i class="lucide-target" aria-hidden="true"></i>
              <span>Weekly review</span>
            </button>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div class="modal" id="taskModal" aria-hidden="true" role="dialog" aria-labelledby="taskModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="card-title" id="taskModalTitle">Create New Task</h2>
        <button class="btn-icon btn-secondary" onclick="closeModal('taskModal')" aria-label="Close">
          <i class="lucide-x" aria-hidden="true"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <input type="hidden" id="taskId" />
          <div class="form-group">
            <label class="form-label" for="taskTitle">Task title</label>
            <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="taskDescription">Description</label>
            <textarea class="form-textarea" id="taskDescription" placeholder="Add details about this task..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Priority level</label>
            <div class="priority-selector" id="prioritySelector">
              <button type="button" class="priority-option high" data-priority="high" aria-pressed="false">
                <i class="lucide-alert-circle" aria-hidden="true"></i>
                <div>High</div>
              </button>
              <button type="button" class="priority-option medium selected" data-priority="medium" aria-pressed="true">
                <i class="lucide-alert-triangle" aria-hidden="true"></i>
                <div>Medium</div>
              </button>
              <button type="button" class="priority-option low" data-priority="low" aria-pressed="false">
                <i class="lucide-info" aria-hidden="true"></i>
                <div>Low</div>
              </button>
            </div>
          </div>
          <div class="grid two-col gap-4">
            <div class="form-group">
              <label class="form-label" for="taskDate">Date</label>
              <input type="date" class="form-input" id="taskDate" required />
            </div>
            <div class="form-group">
              <label class="form-label" for="taskTime">Time</label>
              <input type="time" class="form-input" id="taskTime" />
            </div>
          </div>
          <div class="grid two-col gap-4">
            <div class="form-group">
              <label class="form-label" for="taskDuration">Duration (min)</label>
              <input type="number" class="form-input" id="taskDuration" value="60" min="15" step="15" />
            </div>
            <div class="form-group">
              <label class="form-label" for="taskCategory">Category</label>
              <select class="form-select" id="taskCategory">
                <option value="work">Work</option>
                <option value="personal">Personal</option>
                <option value="fitness">Fitness</option>
                <option value="learning">Learning</option>
                <option value="wellness">Wellness</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="taskGoal">Link to goal</label>
            <select class="form-select" id="taskGoal">
              <option value="">No specific goal</option>
              <option value="q4-launch">Q4 Product Launch</option>
              <option value="fitness">Fitness Goals 2024</option>
              <option value="spanish">Learn Spanish</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
        <button class="btn btn-secondary hidden" id="deleteTaskBtn" onclick="handleDeleteTask()">
          <i class="lucide-trash-2" aria-hidden="true"></i>
          <span>Delete</span>
        </button>
        <button class="btn" id="saveTaskBtn" onclick="handleSaveTask()">
          <i class="lucide-check" aria-hidden="true"></i>
          <span id="saveTaskBtnText">Create Task</span>
        </button>
      </div>
    </div>
  </div>

  <button class="fab" onclick="openTaskModal()" aria-label="Create task">
    <i class="lucide-plus" aria-hidden="true"></i>
  </button>

<script src="productivity-core.js"></script>
    <script src="task-manager.js"></script>
    <script src="integration.js"></script>
    <script>
        // Additional UI enhancements & Task CRUD wiring
        function openTaskModal(task) {
            const modal = document.getElementById('taskModal');
            const isEdit = !!task;
            document.getElementById('taskModalTitle').textContent = isEdit ? 'Edit Task' : 'Create New Task';
            document.getElementById('saveTaskBtnText').textContent = isEdit ? 'Update Task' : 'Create Task';
            const delBtn = document.getElementById('deleteTaskBtn');
            delBtn.classList.toggle('hidden', !isEdit);

            // Defaults
            const today = new Date();
            document.getElementById('taskId').value = task?.id ?? '';
            document.getElementById('taskTitle').value = task?.title ?? '';
            document.getElementById('taskDescription').value = task?.description ?? '';
            document.getElementById('taskDate').value = task?.date ?? today.toISOString().split('T')[0];
            document.getElementById('taskTime').value = task?.time ?? '';
            document.getElementById('taskDuration').value = task?.duration ?? 60;
            document.getElementById('taskCategory').value = task?.category ?? 'personal';
            document.getElementById('taskGoal').value = task?.goalId ?? '';

            // Priority select
            document.querySelectorAll('#prioritySelector .priority-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.priority === (task?.priority ?? 'medium'));
                btn.setAttribute('aria-pressed', btn.classList.contains('selected'));
            });

            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function handleSaveTask() {
            const id = document.getElementById('taskId').value;
            const task = {
                id: id ? Number(id) : undefined,
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                priority: document.querySelector('#prioritySelector .priority-option.selected')?.dataset.priority || 'medium',
                date: document.getElementById('taskDate').value,
                time: document.getElementById('taskTime').value,
                duration: parseInt(document.getElementById('taskDuration').value) || 60,
                category: document.getElementById('taskCategory').value,
                goalId: document.getElementById('taskGoal').value || null,
                completed: false
            };

            if (!task.title || !task.date) {
                alert('Please fill in required fields');
                return;
            }

            await window.TaskAPI.ensureDBReady();
            if (id) {
                await window.TaskAPI.updateTask(task);
            } else {
                await window.TaskAPI.saveTask(task);
            }
            closeModal('taskModal');
            document.getElementById('taskForm').reset();
        }

        async function handleDeleteTask() {
            const id = document.getElementById('taskId').value;
            if (!id) return;
            if (!confirm('Delete this task?')) return;
            await window.TaskAPI.deleteTask(Number(id));
            closeModal('taskModal');
        }

        function quickAddTask() {
            const input = document.getElementById('quickTaskInput');
            const title = input?.value?.trim();
            if (!title) return;
            const today = new Date();
            const task = {
                title,
                description: '',
                priority: 'medium',
                date: today.toISOString().split('T')[0],
                time: '',
                duration: 60,
                category: document.querySelector('.category-card.active')?.querySelector('.category-name')?.textContent.toLowerCase() || 'personal',
                goalId: null,
                completed: false
            };
            window.TaskAPI.saveTask(task);
            input.value = '';
        }

        // Initialize variables
    let currentView = 'week';
    let currentWeekOffset = 0;
    let hourRange = { start: 8, end: 20 };
        
        // Priority selector
        document.querySelectorAll('.priority-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        // Category cards
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            });
        });
        
        // View switching
        function changeView(view) {
            currentView = view;
            updateCalendarView();
        }

        function goToToday() {
            currentWeekOffset = 0;
            updateCalendarView();
        }

        function navigateWeek(direction) {
            currentWeekOffset += direction;
            updateCalendarView();
        }
        
        // duplicate saveTask removed (using the earlier definition above)

        function updateCalendarView() {
            const calendarView = document.getElementById('calendarView');
            
            if (currentView === 'week') {
                renderWeekView(calendarView);
            } else if (currentView === 'day') {
                renderDayView(calendarView);
            } else if (currentView === 'month') {
                renderMonthView(calendarView);
            }
        }

        function renderWeekView(container) {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Update week display
            const weekEnd = new Date(startOfWeek);
            weekEnd.setDate(startOfWeek.getDate() + 6);
            document.getElementById('weekDisplay').textContent = 
                `${months[startOfWeek.getMonth()]} ${startOfWeek.getDate()}-${weekEnd.getDate()}, ${startOfWeek.getFullYear()}`;
            
            // Reset grid columns for week view
            container.style.gridTemplateColumns = '60px repeat(7, 1fr)';
            
            // Build week grid
            let html = '<div></div>'; // Empty corner cell
            
            // Day headers
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const isToday = date.toDateString() === today.toDateString();
                
                html += `<div class="calendar-header-cell ${isToday ? 'today' : ''}">
                    ${days[i]} ${date.getDate()}
                </div>`;
            }
            
            // Time slots (8 AM to 8 PM)
            for (let hour = hourRange.start; hour <= hourRange.end; hour++) {
                html += `<div class="time-slot-label">${hour % 12 || 12}:00 ${hour < 12 ? 'AM' : 'PM'}</div>`;
                
                for (let day = 0; day < 7; day++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + day);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    html += `<div class="calendar-cell" data-hour="${hour}" data-day="${day}" data-date="${dateStr}"></div>`;
                }
            }
            
            container.innerHTML = html;
            loadTasksIntoCalendar();
        }

        function renderDayView(container) {
            const today = new Date();
            today.setDate(today.getDate() + currentWeekOffset);
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            document.getElementById('weekDisplay').textContent = 
                `${days[today.getDay()]}, ${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
            
            let html = '<div class="day-title">Daily Schedule</div>';
            
            const dateStr = today.toISOString().split('T')[0];
            
            // Hourly slots for single day
            for (let hour = hourRange.start; hour <= Math.max(hourRange.end, hourRange.start); hour++) {
                html += `
                    <div class="time-slot-label">${hour % 12 || 12}:00 ${hour < 12 ? 'AM' : 'PM'}</div>
                    <div class="calendar-cell day-span" data-hour="${hour}" data-date="${dateStr}"></div>
                `;
            }
            
            container.style.gridTemplateColumns = '100px 1fr';
            container.innerHTML = html;
            loadTasksIntoCalendar();
        }

        function renderMonthView(container) {
            const today = new Date();
            const currentMonth = new Date(today.getFullYear(), today.getMonth() + currentWeekOffset, 1);
            const firstDay = currentMonth.getDay();
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('weekDisplay').textContent = 
                `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let html = '';
            
            // Day headers
            days.forEach(day => {
                html += `<div class="calendar-header-cell">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-cell calendar-cell-empty"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const isToday = date.toDateString() === today.toDateString();
                const dateStr = date.toISOString().split('T')[0];
                
                html += `
                    <div class="calendar-cell ${isToday ? 'today' : ''} calendar-cell-month">
                        <div class="month-day-number">${day}</div>
                        <div class="task-container" data-date="${dateStr}"></div>
                    </div>
                `;
            }
            
            container.style.gridTemplateColumns = 'repeat(7, 1fr)';
            container.innerHTML = html;
            loadTasksIntoCalendar();
        }

        async function loadTasksIntoCalendar() {
            try {
                await window.TaskAPI.ensureDBReady();
                const allTasks = await window.TaskAPI.getAllTasks();

                if (currentView === 'month') {
                    allTasks.forEach(task => {
                        const container = document.querySelector(`[data-date="${task.date}"]`);
                        if (container) {
                            const taskEl = document.createElement('div');
                            taskEl.className = `task-card priority-${task.priority} month-task-chip`;
                            taskEl.innerHTML = `<div class="fw-600">${task.title}</div>`;
                            taskEl.onclick = () => editTask(task);
                            container.appendChild(taskEl);
                        }
                    });
                } else {
                    allTasks.forEach(task => {
                        if (task.time) {
                            const hour = parseInt(task.time.split(':')[0]);
                            if (hour < hourRange.start || hour > hourRange.end) return; // skip outside selected range
                            const cells = document.querySelectorAll(`[data-hour="${hour}"][data-date="${task.date}"]`);
                            cells.forEach(cell => {
                                const taskEl = document.createElement('div');
                                taskEl.className = `task-card priority-${task.priority} ${task.completed ? 'completed' : ''}`;
                                taskEl.innerHTML = `
                                    <div class="task-time">${task.time}</div>
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        <span class="task-tag">${task.category}</span>
                                    </div>
                                `;
                                taskEl.onclick = () => editTask(task);
                                cell.appendChild(taskEl);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function editTask(task) {
            openTaskModal(task);
        }
        
        
        
        function addTemplate(type) {
            const templates = {
                standup: {
                    title: 'Daily Standup',
                    time: '08:30',
                    duration: 30,
                    category: 'work',
                    priority: 'high'
                },
                workout: {
                    title: 'Workout Session',
                    time: '18:00',
                    duration: 60,
                    category: 'fitness',
                    priority: 'medium'
                },
                review: {
                    title: 'Weekly Review',
                    time: '16:00',
                    duration: 45,
                    category: 'work',
                    priority: 'medium'
                }
            };
            
            const template = templates[type];
            if (!template) return;
            
            const today = new Date();
            const task = {
                ...template,
                date: today.toISOString().split('T')[0],
                description: '',
                goalId: null,
                completed: false
            };
            
            // Save to IndexedDB
            const request = indexedDB.open('ProductivityDB', 1);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['tasks'], 'readwrite');
                const store = transaction.objectStore('tasks');
                
                store.add(task);
                
                transaction.oncomplete = () => {
                    console.log('Template task added:', task);
                    updateCalendarView();
                    showSuccessMessage(`[OK] "${template.title}" added to today's schedule`);
                };
            };
        }
        
        function openGoalModal() {
            // For now, just show an alert. You can implement a full modal later
            alert('Goal creation modal coming soon! For now, goals are created through the data generator.');
        }
        
        function showSuccessMessage(message) {
            const el = document.createElement('div');
            el.className = 'toast toast-success';
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // Modal focus trap and Esc to close
        (function initModalA11y(){
            const modal = document.getElementById('taskModal');
            const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            function trap(e){
                if (!modal.classList.contains('active')) return;
                if (e.key === 'Escape') { closeModal('taskModal'); return; }
                if (e.key !== 'Tab') return;
                const focusables = modal.querySelectorAll(focusableSelector);
                if (!focusables.length) return;
                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
            document.addEventListener('keydown', trap);
        })();

        // Initialize calendar on load
        document.addEventListener('DOMContentLoaded', () => {
            // Load defaults from settings
            try {
                const s = JSON.parse(localStorage.getItem('appSettings') || '{}');
                if (s?.planner) {
                    hourRange.start = Number.isFinite(s.planner.start) ? s.planner.start : hourRange.start;
                    hourRange.end = Number.isFinite(s.planner.end) ? s.planner.end : hourRange.end;
                } else if (s?.sleep) {
                    // Derive from sleep schedule: start 1h after wake, end 2h before bed
                    const wake = s.sleep.wake || '07:00';
                    const bed = s.sleep.bed || '22:30';
                    const [wh,] = wake.split(':').map(Number);
                    const [bh,] = bed.split(':').map(Number);
                    hourRange.start = wh + 1;
                    hourRange.end = Math.max(wh + 2, bh - 2);
                }
            } catch {}
            setTimeout(() => updateCalendarView(), 100);
            window.addEventListener('tasks-changed', () => {
                // Re-render calendar when tasks change
                updateCalendarView();
            });
            // Bind hour selectors
            const hs = document.getElementById('hourStart');
            const he = document.getElementById('hourEnd');
            // Reflect settings into selects
            if (hs) hs.value = String(hourRange.start);
            if (he) he.value = String(hourRange.end);
            const onHourChange = () => {
                const s = parseInt(hs.value);
                const e = parseInt(he.value);
                hourRange.start = Math.min(s, e - 1);
                hourRange.end = Math.max(e, s + 1);
                updateCalendarView();
            };
            if (hs && he) {
                hs.addEventListener('change', onHourChange);
                he.addEventListener('change', onHourChange);
            }
            // Initialize demo goal progress widths (no inline styles)
            const gp1 = document.getElementById('goalProgress1');
            const gp2 = document.getElementById('goalProgress2');
            const gp3 = document.getElementById('goalProgress3');
            if (gp1) gp1.style.width = '60%';
            if (gp2) gp2.style.width = '75%';
            if (gp3) gp3.style.width = '60%';
        });
    </script>
</body>
</html>