<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prios - Reflection</title>
  <link rel="stylesheet" href="theme.css" />
  <style>
    body { margin: 0; }
    .reflection-shell { display: flex; flex-direction: column; gap: var(--space-5); }
    .reflection-heading { display: flex; flex-direction: column; gap: var(--space-2); }
    .reflection-heading h1 { font-size: 1.85rem; font-weight: 700; margin: 0; }
    .reflection-heading p { max-width: 60ch; color: var(--color-text-secondary); margin: 0; }
    .reflection-panels { display: flex; flex-direction: column; gap: var(--space-4); }
    .reflection-panel { transition: opacity var(--transition-base); }
    .reflection-panel.hidden { display: none !important; }

    .actions { display: flex; justify-content: flex-end; gap: var(--space-2); margin-top: var(--space-3); }

    .journal-textarea { min-height: 220px; }

    .preview-container { margin-top: var(--space-3); display: grid; gap: var(--space-3); }
    .preview-header { font-weight: 600; letter-spacing: 0.02em; text-transform: uppercase; color: var(--color-text-secondary); }
    .task-preview { border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(15, 23, 42, 0.64); border-radius: var(--radius-md); padding: var(--space-3); box-shadow: var(--shadow-inset); display: grid; gap: var(--space-2); }
    .task-preview.high-confidence { border-color: rgba(52, 211, 153, 0.32); }
    .task-preview.medium-confidence { border-color: rgba(251, 191, 36, 0.3); }
    .task-preview.low-confidence { border-color: rgba(248, 113, 113, 0.3); }
    .task-header { display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); }
    .task-title { font-weight: 600; }
    .task-meta { display: flex; flex-wrap: wrap; gap: var(--space-2); font-size: 0.82rem; color: var(--color-text-muted); }
    .category-badge { padding: 0.15rem 0.6rem; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.25); font-size: 0.72rem; text-transform: capitalize; }
    .confidence-bar { position: relative; height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.15); overflow: hidden; }
    .confidence-fill { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(91, 143, 255, 0.85), rgba(138, 92, 245, 0.85)); }
    .confidence-label { font-size: 0.75rem; color: var(--color-text-muted); }

    .autocomplete { position: relative; }
    .suggestions { position: absolute; inset-inline: 0; top: calc(100% + var(--space-1)); background: rgba(17, 25, 40, 0.95); border: 1px solid rgba(148, 163, 184, 0.22); border-radius: var(--radius-sm); box-shadow: var(--shadow-sm); max-height: 200px; overflow: auto; display: none; z-index: 15; }
    .suggestions.visible { display: block; }
    .suggestion { padding: var(--space-2) var(--space-3); cursor: pointer; color: var(--color-text-secondary); }
    .suggestion:hover { background: rgba(91, 143, 255, 0.14); color: var(--color-text-primary); }

    .task-grid { display: grid; gap: var(--space-3); }
    .cols-2 { grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); }
    .cols-3 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

    .note-inline { margin-top: var(--space-3); padding: var(--space-3); border-radius: var(--radius-sm); background: rgba(15, 23, 42, 0.5); border: 1px dashed rgba(148, 163, 184, 0.2); color: var(--color-text-muted); }
  </style>
</head>
<body>
  <div class="header-nav">
    <div class="brand">Prios</div>
    <div class="links">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="todo-list.html">To-Do</a>
      <a href="task-planner-enhanced.html">Planner</a>
      <a href="productivity-parallel-coords.html">Analytics</a>
      <a href="reflection.html" class="active">Reflection</a>
      <a href="settings.html">Settings</a>
    </div>
  </div>

  <main class="app-shell">
    <section class="surface-card reflection-shell">
      <header class="reflection-heading">
        <span class="section-title">Daily cadence</span>
        <h1>Reflection</h1>
        <p>Capture what happened, how it felt, and let the NLP assistant turn narrative notes into structured tasks with confidence and context.</p>
      </header>

      <div class="tabs" id="reflectionTabs">
        <button class="tab active" id="journalTab">Journal</button>
        <button class="tab" id="tasksTab">Task List</button>
      </div>

      <div class="reflection-panels">
        <section class="surface-panel reflection-panel" id="journalView">
          <label class="helper" for="journalInput">Free-form reflection</label>
          <textarea id="journalInput" class="input journal-textarea" placeholder="e.g., Worked on the Q4 launch plan for 1h 20m, had a 30m team sync, gym for 45m. Felt productive and focused."></textarea>

          <div class="actions">
            <button class="btn btn-ghost" id="previewBtn">Preview Parse</button>
            <button class="btn" id="saveJournalBtn">Save to Tasks</button>
          </div>

          <div id="journalPreview" class="preview-container"></div>
        </section>

        <section class="surface-panel reflection-panel hidden" id="taskListView">
          <div class="task-grid">
            <div class="autocomplete">
              <label class="helper" for="taskTitle">Task title (search history)</label>
              <input id="taskTitle" class="input" placeholder="Start typing..." />
              <div id="titleSuggestions" class="suggestions"></div>
            </div>

            <div class="task-grid cols-2">
              <div>
                <label class="helper" for="taskDate">Date</label>
                <input id="taskDate" type="date" class="input" title="Date" />
              </div>
              <div>
                <label class="helper" for="taskTime">Time (optional)</label>
                <input id="taskTime" type="time" class="input" title="Time (optional)" />
              </div>
            </div>

            <div class="task-grid cols-3">
              <div>
                <label class="helper" for="taskDuration">Duration (min)</label>
                <input id="taskDuration" type="number" class="input" min="5" step="5" value="60" title="Duration in minutes" />
              </div>
              <div>
                <label class="helper" for="taskCategory">Category</label>
                <select id="taskCategory" class="input" title="Category">
                  <option value="work">Work</option>
                  <option value="learning">Learning</option>
                  <option value="fitness">Fitness</option>
                  <option value="personal">Personal</option>
                  <option value="wellness">Wellness</option>
                </select>
              </div>
              <div>
                <label class="helper" for="taskPriority">Priority</label>
                <select id="taskPriority" class="input" title="Priority">
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="low">Low</option>
                </select>
              </div>
            </div>

            <div>
              <label class="helper" for="taskNotes">Notes / feelings</label>
              <textarea id="taskNotes" rows="3" class="input" placeholder="Optional context"></textarea>
            </div>

            <div class="actions">
              <button class="btn btn-ghost" id="addTaskBtn">Add Task</button>
              <button class="btn" id="saveTasksBtn">Save All</button>
            </div>

            <div id="taskList" class="note-inline">No tasks queued yet.</div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    const journalTab = document.getElementById('journalTab');
    const tasksTab = document.getElementById('tasksTab');
    const journalView = document.getElementById('journalView');
    const taskListView = document.getElementById('taskListView');

    journalTab.addEventListener('click', () => {
      journalTab.classList.add('active');
      tasksTab.classList.remove('active');
      journalView.classList.remove('hidden');
      taskListView.classList.add('hidden');
    });

    tasksTab.addEventListener('click', () => {
      tasksTab.classList.add('active');
      journalTab.classList.remove('active');
      taskListView.classList.remove('hidden');
      journalView.classList.add('hidden');
    });

    async function getTaskSuggestions(prefix) {
      return new Promise((resolve) => {
        const request = indexedDB.open('ProductivityDB', 1);
        request.onsuccess = (e) => {
          const db = e.target.result;
          const tx = db.transaction(['tasks'], 'readonly');
          const store = tx.objectStore('tasks');
          const req = store.getAll();
          req.onsuccess = () => {
            const titles = Array.from(new Set(req.result.map(t => t.title)))
              .filter(t => t && t.toLowerCase().startsWith(prefix.toLowerCase()))
              .slice(0, 10);
            resolve(titles);
          };
        };
        request.onerror = () => resolve([]);
      });
    }

    function showSuggestions(list) {
      const box = document.getElementById('titleSuggestions');
      box.innerHTML = '';
      if (!list.length) {
        box.classList.remove('visible');
        return;
      }
      list.forEach(t => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = t;
        div.onclick = () => {
          document.getElementById('taskTitle').value = t;
          box.classList.remove('visible');
        };
        box.appendChild(div);
      });
      box.classList.add('visible');
    }

    document.getElementById('taskTitle').addEventListener('input', async (e) => {
      const v = e.target.value.trim();
      if (!v) {
        showSuggestions([]);
        return;
      }
      showSuggestions(await getTaskSuggestions(v));
    });

    const taskBuffer = [];
    document.getElementById('addTaskBtn').addEventListener('click', () => {
      const titleField = document.getElementById('taskTitle');
      const title = titleField.value.trim();
      if (!title) {
        alert('Title required');
        return;
      }
      const task = {
        title,
        date: document.getElementById('taskDate').value || new Date().toISOString().split('T')[0],
        time: document.getElementById('taskTime').value || '',
        duration: parseInt(document.getElementById('taskDuration').value || '60', 10),
        category: document.getElementById('taskCategory').value,
        priority: document.getElementById('taskPriority').value,
        description: document.getElementById('taskNotes').value || '',
        goalId: null,
        completed: true
      };
      taskBuffer.push(task);
      document.getElementById('taskList').textContent = `${taskBuffer.length} task(s) queued.`;
      titleField.value = '';
      document.getElementById('taskNotes').value = '';
      showSuggestions([]);
    });

    document.getElementById('saveTasksBtn').addEventListener('click', async () => {
      if (!taskBuffer.length) {
        alert('No tasks to save.');
        return;
      }
      if (window.TaskAPI?.ensureDBReady) {
        await window.TaskAPI.ensureDBReady();
      }
      for (const task of taskBuffer) {
        await window.TaskAPI.saveTask(task);
      }
      taskBuffer.length = 0;
      document.getElementById('taskList').textContent = 'Saved. Analytics will update shortly.';
    });

    document.addEventListener('DOMContentLoaded', () => {
      try {
        const s = JSON.parse(localStorage.getItem('appSettings') || '{}');
        const nlpOn = (s.nlpEnabled || 'on') === 'on';
        if (!nlpOn) {
          tasksTab.classList.add('active');
          journalTab.classList.remove('active');
          taskListView.classList.remove('hidden');
          journalView.classList.add('hidden');
          const note = document.createElement('div');
          note.className = 'note-inline';
          note.textContent = 'Journal parsing is disabled in Settings. You can still add tasks below.';
          taskListView.prepend(note);
        } else {
          const script = document.createElement('script');
          script.src = 'JournalNLPParser.js';
          script.defer = true;
          document.body.appendChild(script);
        }
      } catch (err) {
        console.warn('Unable to read settings', err);
      }
    });
  </script>
  <script src="productivity-core.js"></script>
  <script src="task-manager.js"></script>
</body>
</html>
